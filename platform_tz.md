# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Платформа агрегации GPU-мощностей

---

## 1. ОБЩИЕ СВЕДЕНИЯ

### 1.1 Назначение
Платформа для агрегации GPU-мощностей от частных лиц и организаций с последующей перепродажей через marketplace (VAST.AI и аналоги).

### 1.2 Роли пользователей
- **Администратор** (владелец платформы)
- **Поставщик мощностей** (владелец оборудования)
- **Покупатель** (конечный пользователь, через внешние площадки)

---

## 2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1 Личный кабинет поставщика

#### Регистрация и авторизация (Email-based)

**Обязательная регистрация по email:**
- Email является основным идентификатором пользователя
- Пароль: минимум 8 символов, буквы + цифры
- Подтверждение email через ссылку/код
- Восстановление пароля через email

**Авторизация:**
- Вход по email + пароль
- Запомнить меня (опционально)
- Сессии с авто-выходом через 24ч

**Безопасность:**
- Двухфакторная аутентификация (2FA) — опционально
- История входов (IP, время, устройство)
- Блокировка после 5 неудачных попыток
- Верификация личности (KYC) — опционально

#### Управление оборудованием
- Добавление GPU/сервера:
  - Модель GPU (RTX 3090, A100, и т.д.)
  - Количество
  - Характеристики (VRAM, CUDA-ядер, память)
  - IP-адрес и порт для подключения
  - SSH/VNC доступ
  - Цена аренды за час
- Редактирование/удаление
- Статус: онлайн/офлайн/занято
- Статистика использования и дохода

#### Финансы
- Баланс личного кабинета
- История транзакций
- Вывод средств (карта, крипта)
- Начисления от аренды

---

### 2.2 Панель администратора

#### Мониторинг
- Список всех подключенных GPU
- Статус каждого устройства (online/offline/busy)
- Загрузка (CPU, GPU, RAM)
- Аптайм
- География размещения

#### Управление поставщиками
- Список пользователей
- Верификация
- Блокировка/разблокировка
- Комиссия для каждого поставщика (%)

#### Интеграции
- Подключение к VAST.AI API
- Подключение к другим marketplace (RunPod, Lambda, и т.д.)
- Автоматическая публикация GPU
- Синхронизация цен

#### Финансы
- Общий баланс платформы
- Комиссия платформы (X%)
- Выплаты поставщикам
- Отчеты по доходам

---

### 2.3 Интеграция с VAST.AI

#### Автоматизация
- Регистрация хостов через API
- Автоматическое выставление на продажу
- Управление ценами
- Мониторинг бронирований

#### API-методы
- Создание instance
- Обновление статуса
- Получение списка бронирований
- Автоматические выплаты

---

---

### 2.4 Собственный Marketplace (в разработке)

#### Концепция
Собственная платформа для прямой продажи GPU-мощностей без посредников. Система интеллектуальной оркестрации автоматически распределяет задачи между доступными ресурсами.

#### Преимущества
- **Без посредников** — прямые продажи, выше маржа
- **Оркестрация** — автоматическое распределение задач
- **Автомасштабирование** — система сама выбирает количество ресурсов
- **Единый API** — один интерфейс для всех покупателей

#### Компоненты системы

**1. Task Scheduler (Планировщик задач)**
- Анализ сложности входящей задачи
- Оценка требуемых ресурсов (VRAM, CUDA cores, время)
- Автоматический выбор оптимальной конфигурации
- Очередь задач с приоритетами

**2. Resource Orchestrator (Оркестратор ресурсов)**
- Мониторинг доступных GPU в реальном времени
- Автоматическое масштабирование:
  - Малая задача → 1-2 GPU
  - Средняя задача → 4-8 GPU  
  - Большая задача → 16+ GPU, кластер
- Load balancing между серверами
- Failover — перенос задачи при падении ноды

**3. Auto-Scaling Engine**
```
Задача поступает
    ↓
Анализ: ML training, 50GB VRAM, 24h
    ↓
Подбор: 2×A100 80GB + 4×RTX 4090
    ↓
Авто-развёртывание кластера
    ↓
Запуск задачи → Мониторинг → Завершение
    ↓
Расчёт стоимости → Списание
```

**4. Типы задач (автоопределение)**
| Тип | Примеры | Ресурсы |
|-----|---------|---------|
| Light | Inference, API | 1×GPU, 2-4h |
| Medium | Fine-tuning, Rendering | 2-4×GPU, 8-12h |
| Heavy | Training LLM, Cluster compute | 8-16×GPU, 24h+ |
| Parallel | Distributed training | Auto-cluster |

#### API Marketplace

**Загрузка задачи:**
- `POST /marketplace/jobs` — создать задачу
  ```json
  {
    "type": "ml_training",
    "framework": "pytorch",
    "dataset_size": "500GB",
    "model_params": "70B",
    "priority": "high",
    "max_budget": 1000
  }
  ```
- `GET /marketplace/jobs/{id}/quote` — получить смету
- `POST /marketplace/jobs/{id}/confirm` — подтвердить запуск

**Управление задачей:**
- `GET /marketplace/jobs/{id}` — статус задачи
- `GET /marketplace/jobs/{id}/logs` — логи выполнения
- `GET /marketplace/jobs/{id}/resources` — используемые ресурсы
- `POST /marketplace/jobs/{id}/cancel` — отмена
- `POST /marketplace/jobs/{id}/extend` — продление

**Мониторинг:**
- `GET /marketplace/cluster/status` — состояние кластера
- `GET /marketplace/pricing` — актуальные цены
- `GET /marketplace/queue` — очередь задач

#### Технологии оркестрации
- **Kubernetes** — управление контейнерами
- **Ray / Dask** — распределённые вычисления
- **Slurm** — планировщик HPC задач
- **Prometheus + Grafana** — мониторинг кластера

#### Биллинг оркестрации
- Почасовая оплата фактически использованных ресурсов
- Автоматическая остановка при превышении бюджета
- Гибкое ценообразование по типу задачи

---

### 2.5 API для дата-центров (DC API)

#### Назначение
Программный интерфейс для интеграции дата-центров и крупных поставщиков. Позволяет автоматизировать подключение сотен GPU без ручного ввода.

#### Авторизация
- API Keys (токены с правами доступа)
- IP whitelist
- Rate limiting: 1000 запросов/минуту

#### Методы DC API

**Управление оборудованием:**
- `POST /dc/servers/batch` — массовое добавление серверов
- `PUT /dc/servers/{id}` — обновление сервера
- `DELETE /dc/servers/{id}` — удаление сервера
- `GET /dc/servers` — список всех серверов DC
- `POST /dc/servers/status` — массовое обновление статусов

**Мониторинг:**
- `GET /dc/stats` — статистика по всему DC
- `GET /dc/revenue` — доходы за период
- `GET /dc/utilization` — загрузка оборудования
- `GET /dc/alerts` — алерты и ошибки

**Финансы:**
- `GET /dc/balance` — текущий баланс
- `GET /dc/transactions` — история транзакций
- `POST /dc/withdraw` — запрос на вывод средств

**Вебхуки (Webhooks):**
- Уведомление о бронировании
- Уведомление об окончании аренды
- Уведомление о выплате
- Уведомление об ошибке сервера

---

### 2.6 API для покупателей (Customer API)

#### Назначение
API для конечных клиентов, арендующих GPU. Используется для автоматизации аренды через скрипты, CI/CD, ML-пайплайны.

#### Авторизация
- Bearer токены (JWT)
- Депозит обязателен для доступа
- Rate limiting: 100 запросов/минуту

#### Методы Customer API

**Поиск и выбор GPU:**
- `GET /market/gpu` — список доступных GPU с фильтрами
  - Фильтры: модель, цена, локация, VRAM
  - Сортировка: по цене, по производительности
- `GET /market/gpu/{id}` — детали конкретной карты
- `GET /market/prices` — актуальные цены
- `GET /market/locations` — доступные локации

**Аренда:**
- `POST /rentals` — создать аренду
  - Параметры: GPU ID, длительность, образ
  - Автоматический выбор оптимальной карты
- `GET /rentals` — список моих аренд
- `GET /rentals/{id}` — детали аренды
- `DELETE /rentals/{id}` — завершить аренду досрочно
- `POST /rentals/{id}/extend` — продлить аренду

**Управление инстансом:**
- `GET /rentals/{id}/connection` — данные для подключения (IP, порт, SSH)
- `POST /rentals/{id}/reboot` — перезагрузка
- `GET /rentals/{id}/logs` — логи работы
- `GET /rentals/{id}/stats` — статистика использования

**Финансы:**
- `GET /account/balance` — баланс
- `POST /account/deposit` — пополнение
- `GET /account/invoices` — история платежей

---

### 2.7 Протокол Proof of Useful Work (PoUW)

#### Концепция
Децентрализованный протокол верификации выполнения полезных вычислений. В отличие от Proof of Work (бессмысленные хеши), PoUW подтверждает реальное выполнение задач с экономической ценностью.

#### Суть протокола
**Оплата только за фактически выполненные вычисления:**
- Поставщик GPU выполняет задачу клиента
- Система верифицирует корректность результата
- Оплата начисляется только при успешном завершении
- Учитывается фактическое время вычислений

#### Архитектура протокола

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Клиент    │────▶│   Task      │────▶│   GPU       │
│  (заказчик) │     │   Scheduler │     │  (исполнитель)│
└─────────────┘     └─────────────┘     └──────┬──────┘
                                                 │
                         ┌───────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  PoUW Verifier      │
              │  (верификатор)      │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   Smart Contract    │
              │   (выплата)         │
              └─────────────────────┘
```

#### Компоненты системы

**1. Task Scheduler (Планировщик)**
- Разбивает задачу на подзадачи (chunks)
- Распределяет между GPU с учётом сложности
- Назначает deadline для каждой подзадачи

**2. GPU Executor (Исполнитель)**
- Выполняет вычисления
- Генерирует Proof of Computation (PoC)
- Отправляет результат + PoC на верификацию

**3. PoUW Verifier (Верификатор)**
- Проверяет корректность результата:
  - **Детерминированные задачи:** хеш результата должен совпадать
  - **ML задачи:** loss function в пределах нормы
  - **Рендеринг:** pixel-perfect сравнение с эталоном
- Валидация подписи исполнителя
- Проверка времени выполнения (не быстрее физически возможного)

**4. Smart Contract / Billing**
- Хранение депозита клиента
- Автоматическая выплата при успешной верификации
- Слэшинг (штраф) за некорректный результат

#### Методы верификации

| Тип задачи | Метод верификации | Сложность |
|------------|-------------------|-----------|
| ML Training | Проверка gradients + loss | Средняя |
| ML Inference | Сравнение с эталоном | Низкая |
| Rendering | Hash изображения | Низкая |
| Scientific | Replay вычислений | Высокая |
| Blockchain | Verification game | Средняя |

#### Алгоритм работы

```python
# 1. Клиент размещает задачу
task = {
    "type": "ml_training",
    "dataset_hash": "sha256:abc...",
    "expected_result_hash": "sha256:xyz...",
    "max_time": 3600,
    "reward": 100.0,
    "deposit": 110.0  # reward + 10% комиссия
}

# 2. GPU берёт задачу
executor.claim_task(task_id)

# 3. Выполнение + генерация PoC
result = train_model(dataset)
poc = generate_proof(result, secret_nonce)

# 4. Верификация
if verify_proof(poc, task.expected_result_hash):
    payout(executor, task.reward)
else:
    slash(executor, task.reward * 0.1)  # штраф 10%
    refund(client, task.deposit)

# 5. Оплата по времени (time-based)
actual_time = execution_time
if actual_time <= task.max_time:
    time_bonus = (task.max_time - actual_time) * 0.1
    payout(executor, task.reward + time_bonus)
```

#### Экономическая модель PoUW

**Для клиента:**
- Платит только за успешный результат
- Депозит блокируется до верификации
- Гарантия возврата при невыполнении

**Для GPU (исполнителя):**
- Получает оплату только за верифицированную работу
- Бонус за выполнение раньше deadline
- Штраф за некорректный результат (слэшинг)
- Репутационный скор (рейтинг надёжности)

**Для платформы:**
- Комиссия с каждой успешной транзакции
- Арбитраж при спорах
- Стейкинг для валидаторов

#### Безопасность

**Защита от читинга:**
- Детерминированные задачи с известным результатом
- Слепые вычисления (blind computation)
- Verification games (проверка случайных семплов)
- Economic security (стейкинг валидаторов)

**Защита от DDoS:**
- Депозит клиента для размещения задачи
- Rate limiting на создание задач
- Приоритизация по репутации

#### Интеграция с блокчейном (опционально)

**On-chain верификация:**
- Смарт-контракт на Ethereum/Polygon
- Хранение хешей задач и результатов
- Автоматические выплаты

**Off-chain вычисления:**
- Сами вычисления выполняются off-chain
- On-chain только верификация и биллинг
- Layer 2 решения для масштабирования

---

## 3. ТЕХНИЧЕСКАЯ АРХИТЕКТУРА

### 3.1 Компоненты системы
```
┌─────────────────┬─────────────────┬─────────────────┐
│  Web Dashboard  │   DC API        │  Customer API   │
│  (React/Vue)    │  (Data Centers) │  (Renters)      │
└────────┬────────┴────────┬────────┴────────┬────────┘
         │                 │                 │
         └────────┬────────┴────────┬────────┘
                  │                 │
         ┌────────▼─────────────────▼────────┐
         │         API Gateway               │
         │   (Rate limiting, Auth, Routes)   │
         │        ← FastAPI/Node.js          │
         └────────┬──────────────────────────┘
                  │
         ┌────────▼────────┐
         │  Core Services  │  ← Python/Go
         │  - Auth Service │
         │  - DC Manager   │
         │  - Rental Engine│
         │  - Billing      │
         │  - Monitoring   │
         └────────┬────────┘
                  │
         ┌────────▼────────┐
         │    Database     │  ← PostgreSQL
         │  - Users        │
         │  - GPU Servers  │
         │  - Rentals      │
         │  - Transactions │
         │  - API Keys     │
         └────────┬────────┘
                  │
         ┌────────▼──────────────────────────┐
         │          Integrations             │
         │  - VAST.AI API                    │
         │  - RunPod API                     │
         │  - Payment (Stripe, Crypto)       │
         │  - Notification Service           │
         └───────────────────────────────────┘
```

---

## 3.1 ТЕХНОЛОГИЧЕСКИЙ СТЕК (ДЕТАЛЬНО)

### Frontend (Web Dashboard)

#### **React 18 + TypeScript**
- **Почему:** Самая популярная библиотека, огромная экосистема
- **Компоненты:** Ant Design / Material-UI — готовые UI-компоненты
- **State management:** Zustand или Redux Toolkit
- **Charts:** Recharts / Chart.js — графики мониторинга
- **WebSocket:** Socket.io-client — real-time обновления

#### **Next.js 14 (опционально)**
- SSR для SEO и быстрой загрузки
- API Routes для простых endpoint
- Image optimization

---

### Backend API

#### **FastAPI (Python)** ⭐ РЕКОМЕНДУЕТСЯ
- **Почему:** Скорость (async), автодокументация (OpenAPI), типизация
- **ASGI:** Uvicorn + Gunicorn
- **Валидация:** Pydantic — автоматическая валидация данных
- **Авторизация:** FastAPI-Users или собственная на JWT
- **Rate limiting:** Slowapi

**Альтернатива:** Node.js + Express/NestJS

---

### База данных

#### **PostgreSQL 15+**
- **Почему:** Надёжность, сложные запросы, JSON поддержка
- **ORM:** SQLAlchemy (Python) или Prisma (Node.js)
- **Миграции:** Alembic
- **Backup:** pg_dump ежедневно

#### **Redis**
- **Кеширование:** сессии, частые запросы
- **Очереди:** Celery / RQ для background задач
- **Rate limiting:** счётчики запросов

---

### Message Queue (Очереди задач)

#### **RabbitMQ** или **Apache Kafka**
- **Назначение:** 
  - Асинхронная обработка биллинга
  - Вебхуки (webhooks)
  - Логирование событий
  - Уведомления

---

### Контейнеризация & Orchestration

#### **Docker + Docker Compose**
- Контейнеризация всех сервисов
- Локальная разработка
- Простое развёртывание

#### **Kubernetes (K8s)** — для production
- **Оркестрация:** авто-масштабирование подов
- **Ingress:** nginx-ingress-controller
- **Monitoring:** Prometheus + Grafana
- **Logs:** ELK stack или Loki

---

### GPU Orchestration (Оркестрация)

#### **NVIDIA GPU Operator**
- Автоматическая настройка GPU в Kubernetes
- Драйверы, CUDA, device-plugin

#### **Kubeflow / Ray**
- **Kubeflow:** ML pipelines на Kubernetes
- **Ray:** распределённые ML задачи
- **Dask:** параллельные вычисления на Python

#### **Slurm** (альтернатива для HPC)
- Классический планировщик кластеров
- Используется в суперкомпьютерах

---

### Мониторинг & Observability

#### **Prometheus**
- Сбор метрик (CPU, GPU, RAM, температура)
- Alertmanager — алерты

#### **Grafana**
- Визуализация метрик
- Dashboard для администратора

#### **ELK Stack**
- **Elasticsearch:** хранение логов
- **Logstash:** обработка логов
- **Kibana:** просмотр логов

#### **Jaeger / Zipkin**
- Distributed tracing — отслеживание запросов

---

### Безопасность

#### **SSL/TLS**
- Let's Encrypt (бесплатные сертификаты)
- Cert-manager в Kubernetes
- TLS 1.3 обязательно

#### **Firewall & VPN**
- **WireGuard:** VPN для доступа к GPU
- **ufw / iptables:** firewall на серверах
- **Cloudflare:** DDoS защита, CDN

#### **Secrets Management**
- **HashiCorp Vault:** хранение секретов
- Или: Kubernetes Secrets + Sealed Secrets

---

### Интеграции

#### **VAST.AI API**
- REST API для управления хостами
- Webhooks для событий

#### **Платёжные системы**
- **Крипта:** Coinbase Commerce / BTCPay Server
- **Рубли:** ЮKassa / Robokassa / СБП
- **Международные:** Stripe / Paddle

#### **Уведомления**
- **Email:** SendGrid / Mailgun
- **Telegram:** Bot API
- **SMS:** Twilio / smsc.ru

---

### Инфраструктура (Infrastructure)

#### **Cloud провайдеры**
- **Hetzner:** дешёвые серверы в Европе
- **Selectel:** российские серверы
- **AWS/GCP/Azure:** для глобального масштаба

#### **Bare Metal (свои сервера)**
- **OS:** Ubuntu Server 22.04 LTS
- **Docker + K8s** на каждом GPU-сервере
- **PXE boot** — массовая установка

---

### CI/CD (Развёртывание)

#### **GitHub Actions / GitLab CI**
- Автоматическое тестирование
- Сборка Docker образов
- Деплой в Kubernetes

#### **ArgoCD**
- GitOps для Kubernetes
- Автосинхронизация состояния

---

## ИТОГОВЫЙ СТЕК (РЕКОМЕНДАЦИЯ)

| Компонент | Технология | Альтернатива |
|-----------|------------|--------------|
| Frontend | React 18 + TypeScript | Vue 3 |
| Backend | FastAPI (Python) | Node.js + NestJS |
| Database | PostgreSQL 15 | MySQL 8 |
| Cache | Redis | Memcached |
| Queue | RabbitMQ | Apache Kafka |
| Container | Docker + Kubernetes | Docker Compose |
| GPU Orchestration | NVIDIA GPU Operator + Ray | Slurm |
| Monitoring | Prometheus + Grafana | Datadog |
| Logs | ELK Stack | Grafana Loki |
| Auth | JWT + bcrypt | Auth0 |
| Payments | Stripe + Coinbase | Paddle |

---

### 3.2 База данных

#### Таблицы:
- `users` — пользователи (email, password_hash, created_at, verified)
- `sessions` — сессии авторизации (token, user_id, expires_at, ip, user_agent)
- `login_attempts` — попытки входа (email, ip, success, timestamp)
- `gpu_servers` — серверы/оборудование
- `rentals` — аренды
- `transactions` — финансовые операции
- `integrations` — настройки интеграций
- `logs` — логи и мониторинг

### 3.2.1 Система аутентификации

**Email-аутентификация:**
- JWT токены для сессий (access + refresh)
- Хеширование паролей bcrypt/Argon2
- Подтверждение email через токен (24ч валидность)
- Восстановление пароля через secure token

**Защита:**
- Rate limiting: 5 попыток входа/минуту с одного IP
- Блокировка аккаунта после 5 неудачных попыток (15 мин)
- Сессии привязаны к IP + User-Agent
- Авто-выход через 24ч бездействия

### 3.3 Требования к серверу
- CPU: 4+ ядер
- RAM: 8+ GB
- SSD: 50+ GB
- ОС: Ubuntu 22.04 LTS

---

## 4. БЕЗОПАСНОСТЬ

### 4.1 Требования
- HTTPS/TLS 1.3
- Шифрование данных at rest
- Изоляция пользователей (Docker/KVM)
- DDoS-защита
- Backup ежедневно

### 4.2 Доступ к GPU
- VPN/Wireguard для подключения
- SSH-ключи
- Ограничение по IP
- Firewall

---

## 5. ЭТАПЫ РАЗРАБОТКИ

### MVP (2-3 недели)
- [ ] Регистрация/авторизация
- [ ] Добавление GPU
- [ ] Базовый дашборд админа
- [ ] Ручная интеграция с VAST.AI

### Phase 2 (3-4 недели)
- [ ] Автоматическая публикация
- [ ] Биллинг и выплаты
- [ ] Мониторинг в реальном времени
- [ ] Техподдержка (чат)

### Phase 3: Инфраструктура оркестрации (6-8 недель) ⭐ КЛЮЧЕВОЙ ЭТАП
- [ ] **Развёртывание Kubernetes кластера**
  - Установка на GPU-серверах
  - NVIDIA GPU Operator
  - Container Runtime (containerd)
- [ ] **Настройка оркестрации**
  - Ray Cluster / Kubeflow
  - Task Scheduler
  - Auto-scaling engine
- [ ] **Мониторинг кластера**
  - Prometheus + Grafana для GPU
  - NVIDIA DCGM exporter
  - Алерты на температуру/загрузку
- [ ] **API Marketplace (собственный)**
  - Task Queue (RabbitMQ/Kafka)
  - Job Orchestrator
  - Resource Allocator
- [ ] **CI/CD для GPU-нод**
  - Автоматическое обновление
  - Rollback при ошибках
  - Health checks

### Phase 4 (4+ недели)
- [ ] Мобильное приложение
- [ ] Расширенная аналитика
- [ ] ML-мониторинг и предсказания
- [ ] Интеграция с внешними ML-платформами

---

## 6. БИЗНЕС-МОДЕЛЬ

### Комиссия платформы
- **Фиксированная: 10%** с каждой аренды
- Без tier-ов и премиум-тарифов

### Ценообразование
- Поставщик сам устанавливает цену за час аренды
- Платформа автоматически добавляет 10% комиссии к цене покупателя
- Или: поставщик получает цену минус 10%

### Способы вывода средств
- **Криптовалюта:** USDT (TRC-20, ERC-20), BTC
- **Российский рубль:** банковская карта, СБП

---

## 7. УТОЧНЕННЫЕ ПАРАМЕТРЫ

✅ **Комиссия платформы:** 10% (фиксированная)
✅ **Способы вывода:** Криптовалюта (USDT, BTC) + Российский рубль (карты, СБП)
✅ **Фиксация цен:** Не требуется, поставщик устанавливает самостоятельно

## 8. ВОПРОСЫ ДЛЯ УТОЧНЕНИЯ

1. Какие именно marketplace планируется использовать? (VAST.AI, RunPod, Lambda, др.)
2. Какой минимальный объем GPU для старта?
3. Требуется ли верификация поставщиков (KYC)?
4. Нужен ли white-label для поставщиков?
5. Будет ли API для интеграции дата-центров?

---

**Дата:** 08.02.2026
**Автор:** Deya / OpenClaw
**Статус:** Черновик для обсуждения
