# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Платформа агрегации GPU-мощностей

---

## 1. ОБЩИЕ СВЕДЕНИЯ

### 1.1 Назначение
Платформа для агрегации GPU-мощностей от частных лиц и организаций с последующей перепродажей через marketplace (VAST.AI и аналоги).

### 1.2 Роли пользователей
- **Администратор** (владелец платформы)
- **Поставщик мощностей** (владелец оборудования)
- **Покупатель** (конечный пользователь, через внешние площадки)

---

## 2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1 Личный кабинет поставщика

#### Регистрация и авторизация (Email-based)

**Обязательная регистрация по email:**
- Email является основным идентификатором пользователя
- Пароль: минимум 8 символов, буквы + цифры
- Подтверждение email через ссылку/код
- Восстановление пароля через email

**Авторизация:**
- Вход по email + пароль
- Запомнить меня (опционально)
- Сессии с авто-выходом через 24ч

**Безопасность:**
- Двухфакторная аутентификация (2FA) — опционально
- История входов (IP, время, устройство)
- Блокировка после 5 неудачных попыток
- Верификация личности (KYC) — опционально

#### Управление оборудованием
- Добавление GPU/сервера:
  - Модель GPU (RTX 3090, A100, и т.д.)
  - Количество
  - Характеристики (VRAM, CUDA-ядер, память)
  - IP-адрес и порт для подключения
  - SSH/VNC доступ
  - Цена аренды за час
- Редактирование/удаление
- Статус: онлайн/офлайн/занято
- Статистика использования и дохода

#### Финансы
- Баланс личного кабинета
- История транзакций
- Вывод средств (карта, крипта)
- Начисления от аренды

---

### 2.2 Панель администратора

#### Мониторинг
- Список всех подключенных GPU
- Статус каждого устройства (online/offline/busy)
- Загрузка (CPU, GPU, RAM)
- Аптайм
- География размещения

#### Управление поставщиками
- Список пользователей
- Верификация
- Блокировка/разблокировка
- Комиссия для каждого поставщика (%)

#### Интеграции
- Подключение к VAST.AI API
- Подключение к другим marketplace (RunPod, Lambda, и т.д.)
- Автоматическая публикация GPU
- Синхронизация цен

#### Финансы
- Общий баланс платформы
- Комиссия платформы (X%)
- Выплаты поставщикам
- Отчеты по доходам

---

### 2.3 Интеграция с VAST.AI

#### Автоматизация
- Регистрация хостов через API
- Автоматическое выставление на продажу
- Управление ценами
- Мониторинг бронирований

#### API-методы
- Создание instance
- Обновление статуса
- Получение списка бронирований
- Автоматические выплаты

---

---

### 2.4 Собственный Marketplace (в разработке)

#### Концепция
Собственная платформа для прямой продажи GPU-мощностей без посредников. Система интеллектуальной оркестрации автоматически распределяет задачи между доступными ресурсами.

#### Преимущества
- **Без посредников** — прямые продажи, выше маржа
- **Оркестрация** — автоматическое распределение задач
- **Автомасштабирование** — система сама выбирает количество ресурсов
- **Единый API** — один интерфейс для всех покупателей

#### Компоненты системы

**1. Task Scheduler (Планировщик задач)**
- Анализ сложности входящей задачи
- Оценка требуемых ресурсов (VRAM, CUDA cores, время)
- Автоматический выбор оптимальной конфигурации
- Очередь задач с приоритетами

**2. Resource Orchestrator (Оркестратор ресурсов)**
- Мониторинг доступных GPU в реальном времени
- Автоматическое масштабирование:
  - Малая задача → 1-2 GPU
  - Средняя задача → 4-8 GPU  
  - Большая задача → 16+ GPU, кластер
- Load balancing между серверами
- Failover — перенос задачи при падении ноды

**3. Auto-Scaling Engine**
```
Задача поступает
    ↓
Анализ: ML training, 50GB VRAM, 24h
    ↓
Подбор: 2×A100 80GB + 4×RTX 4090
    ↓
Авто-развёртывание кластера
    ↓
Запуск задачи → Мониторинг → Завершение
    ↓
Расчёт стоимости → Списание
```

**4. Типы задач (автоопределение)**
| Тип | Примеры | Ресурсы |
|-----|---------|---------|
| Light | Inference, API | 1×GPU, 2-4h |
| Medium | Fine-tuning, Rendering | 2-4×GPU, 8-12h |
| Heavy | Training LLM, Cluster compute | 8-16×GPU, 24h+ |
| Parallel | Distributed training | Auto-cluster |

#### API Marketplace

**Загрузка задачи:**
- `POST /marketplace/jobs` — создать задачу
  ```json
  {
    "type": "ml_training",
    "framework": "pytorch",
    "dataset_size": "500GB",
    "model_params": "70B",
    "priority": "high",
    "max_budget": 1000
  }
  ```
- `GET /marketplace/jobs/{id}/quote` — получить смету
- `POST /marketplace/jobs/{id}/confirm` — подтвердить запуск

**Управление задачей:**
- `GET /marketplace/jobs/{id}` — статус задачи
- `GET /marketplace/jobs/{id}/logs` — логи выполнения
- `GET /marketplace/jobs/{id}/resources` — используемые ресурсы
- `POST /marketplace/jobs/{id}/cancel` — отмена
- `POST /marketplace/jobs/{id}/extend` — продление

**Мониторинг:**
- `GET /marketplace/cluster/status` — состояние кластера
- `GET /marketplace/pricing` — актуальные цены
- `GET /marketplace/queue` — очередь задач

#### Технологии оркестрации
- **Kubernetes** — управление контейнерами
- **Ray / Dask** — распределённые вычисления
- **Slurm** — планировщик HPC задач
- **Prometheus + Grafana** — мониторинг кластера

#### Биллинг оркестрации
- Почасовая оплата фактически использованных ресурсов
- Автоматическая остановка при превышении бюджета
- Гибкое ценообразование по типу задачи

---

### 2.5 API для дата-центров (DC API)

#### Назначение
Программный интерфейс для интеграции дата-центров и крупных поставщиков. Позволяет автоматизировать подключение сотен GPU без ручного ввода.

#### Авторизация
- API Keys (токены с правами доступа)
- IP whitelist
- Rate limiting: 1000 запросов/минуту

#### Методы DC API

**Управление оборудованием:**
- `POST /dc/servers/batch` — массовое добавление серверов
- `PUT /dc/servers/{id}` — обновление сервера
- `DELETE /dc/servers/{id}` — удаление сервера
- `GET /dc/servers` — список всех серверов DC
- `POST /dc/servers/status` — массовое обновление статусов

**Мониторинг:**
- `GET /dc/stats` — статистика по всему DC
- `GET /dc/revenue` — доходы за период
- `GET /dc/utilization` — загрузка оборудования
- `GET /dc/alerts` — алерты и ошибки

**Финансы:**
- `GET /dc/balance` — текущий баланс
- `GET /dc/transactions` — история транзакций
- `POST /dc/withdraw` — запрос на вывод средств

**Вебхуки (Webhooks):**
- Уведомление о бронировании
- Уведомление об окончании аренды
- Уведомление о выплате
- Уведомление об ошибке сервера

---

### 2.6 API для покупателей (Customer API)

#### Назначение
API для конечных клиентов, арендующих GPU. Используется для автоматизации аренды через скрипты, CI/CD, ML-пайплайны.

#### Авторизация
- Bearer токены (JWT)
- Депозит обязателен для доступа
- Rate limiting: 100 запросов/минуту

#### Методы Customer API

**Поиск и выбор GPU:**
- `GET /market/gpu` — список доступных GPU с фильтрами
  - Фильтры: модель, цена, локация, VRAM
  - Сортировка: по цене, по производительности
- `GET /market/gpu/{id}` — детали конкретной карты
- `GET /market/prices` — актуальные цены
- `GET /market/locations` — доступные локации

**Аренда:**
- `POST /rentals` — создать аренду
  - Параметры: GPU ID, длительность, образ
  - Автоматический выбор оптимальной карты
- `GET /rentals` — список моих аренд
- `GET /rentals/{id}` — детали аренды
- `DELETE /rentals/{id}` — завершить аренду досрочно
- `POST /rentals/{id}/extend` — продлить аренду

**Управление инстансом:**
- `GET /rentals/{id}/connection` — данные для подключения (IP, порт, SSH)
- `POST /rentals/{id}/reboot` — перезагрузка
- `GET /rentals/{id}/logs` — логи работы
- `GET /rentals/{id}/stats` — статистика использования

**Финансы:**
- `GET /account/balance` — баланс
- `POST /account/deposit` — пополнение
- `GET /account/invoices` — история платежей

---

## 3. ТЕХНИЧЕСКАЯ АРХИТЕКТУРА

### 3.1 Компоненты системы
```
┌─────────────────┬─────────────────┬─────────────────┐
│  Web Dashboard  │   DC API        │  Customer API   │
│  (React/Vue)    │  (Data Centers) │  (Renters)      │
└────────┬────────┴────────┬────────┴────────┬────────┘
         │                 │                 │
         └────────┬────────┴────────┬────────┘
                  │                 │
         ┌────────▼─────────────────▼────────┐
         │         API Gateway               │
         │   (Rate limiting, Auth, Routes)   │
         │        ← FastAPI/Node.js          │
         └────────┬──────────────────────────┘
                  │
         ┌────────▼────────┐
         │  Core Services  │  ← Python/Go
         │  - Auth Service │
         │  - DC Manager   │
         │  - Rental Engine│
         │  - Billing      │
         │  - Monitoring   │
         └────────┬────────┘
                  │
         ┌────────▼────────┐
         │    Database     │  ← PostgreSQL
         │  - Users        │
         │  - GPU Servers  │
         │  - Rentals      │
         │  - Transactions │
         │  - API Keys     │
         └────────┬────────┘
                  │
         ┌────────▼──────────────────────────┐
         │          Integrations             │
         │  - VAST.AI API                    │
         │  - RunPod API                     │
         │  - Payment (Stripe, Crypto)       │
         │  - Notification Service           │
         └───────────────────────────────────┘
```

### 3.2 База данных

#### Таблицы:
- `users` — пользователи (email, password_hash, created_at, verified)
- `sessions` — сессии авторизации (token, user_id, expires_at, ip, user_agent)
- `login_attempts` — попытки входа (email, ip, success, timestamp)
- `gpu_servers` — серверы/оборудование
- `rentals` — аренды
- `transactions` — финансовые операции
- `integrations` — настройки интеграций
- `logs` — логи и мониторинг

### 3.2.1 Система аутентификации

**Email-аутентификация:**
- JWT токены для сессий (access + refresh)
- Хеширование паролей bcrypt/Argon2
- Подтверждение email через токен (24ч валидность)
- Восстановление пароля через secure token

**Защита:**
- Rate limiting: 5 попыток входа/минуту с одного IP
- Блокировка аккаунта после 5 неудачных попыток (15 мин)
- Сессии привязаны к IP + User-Agent
- Авто-выход через 24ч бездействия

### 3.3 Требования к серверу
- CPU: 4+ ядер
- RAM: 8+ GB
- SSD: 50+ GB
- ОС: Ubuntu 22.04 LTS

---

## 4. БЕЗОПАСНОСТЬ

### 4.1 Требования
- HTTPS/TLS 1.3
- Шифрование данных at rest
- Изоляция пользователей (Docker/KVM)
- DDoS-защита
- Backup ежедневно

### 4.2 Доступ к GPU
- VPN/Wireguard для подключения
- SSH-ключи
- Ограничение по IP
- Firewall

---

## 5. ЭТАПЫ РАЗРАБОТКИ

### MVP (2-3 недели)
- [ ] Регистрация/авторизация
- [ ] Добавление GPU
- [ ] Базовый дашборд админа
- [ ] Ручная интеграция с VAST.AI

### Phase 2 (3-4 недели)
- [ ] Автоматическая публикация
- [ ] Биллинг и выплаты
- [ ] Мониторинг в реальном времени
- [ ] Техподдержка (чат)

### Phase 3 (4+ недели)
- [ ] Мобильное приложение
- [ ] API для поставщиков
- [ ] Дополнительные marketplace
- [ ] ML-мониторинг

---

## 6. БИЗНЕС-МОДЕЛЬ

### Комиссия платформы
- **Фиксированная: 10%** с каждой аренды
- Без tier-ов и премиум-тарифов

### Ценообразование
- Поставщик сам устанавливает цену за час аренды
- Платформа автоматически добавляет 10% комиссии к цене покупателя
- Или: поставщик получает цену минус 10%

### Способы вывода средств
- **Криптовалюта:** USDT (TRC-20, ERC-20), BTC
- **Российский рубль:** банковская карта, СБП

---

## 7. УТОЧНЕННЫЕ ПАРАМЕТРЫ

✅ **Комиссия платформы:** 10% (фиксированная)
✅ **Способы вывода:** Криптовалюта (USDT, BTC) + Российский рубль (карты, СБП)
✅ **Фиксация цен:** Не требуется, поставщик устанавливает самостоятельно

## 8. ВОПРОСЫ ДЛЯ УТОЧНЕНИЯ

1. Какие именно marketplace планируется использовать? (VAST.AI, RunPod, Lambda, др.)
2. Какой минимальный объем GPU для старта?
3. Требуется ли верификация поставщиков (KYC)?
4. Нужен ли white-label для поставщиков?
5. Будет ли API для интеграции дата-центров?

---

**Дата:** 08.02.2026
**Автор:** Deya / OpenClaw
**Статус:** Черновик для обсуждения
